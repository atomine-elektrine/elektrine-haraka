name: "CI: Build, Publish, and Deploy"

on:
  push:
    branches:
      - master
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-publish-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=,format=long

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-publish-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      packages: read

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            if [ -z "$DEPLOY_PATH" ]; then
              echo "::error::DEPLOY_PATH secret is empty."
              exit 1
            fi
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "::error::DEPLOY_PATH does not exist on server: $DEPLOY_PATH"
              exit 1
            fi
            cd "$DEPLOY_PATH"
            COMPOSE_BASE_FILE=""
            for candidate in docker-compose.yml docker-compose.yaml compose.yml compose.yaml; do
              if [ -f "$candidate" ]; then
                COMPOSE_BASE_FILE="$candidate"
                break
              fi
            done

            if [ -z "$COMPOSE_BASE_FILE" ]; then
              echo "::error::No docker compose file found in $DEPLOY_PATH"
              ls -la
              exit 1
            fi
            echo "Using compose file: $COMPOSE_BASE_FILE"
            if docker info >/dev/null 2>&1; then
              compose() { docker compose "$@"; }
              docker_cmd() { docker "$@"; }
            elif sudo -n docker info >/dev/null 2>&1; then
              compose() { sudo docker compose "$@"; }
              docker_cmd() { sudo docker "$@"; }
            else
              echo "::error::DEPLOY_USER cannot access Docker daemon."
              echo "::error::Fix by adding the user to the docker group, or allow passwordless sudo for docker."
              id
              groups
              ls -l /var/run/docker.sock || true
              exit 1
            fi

            GHCR_USER="${{ secrets.GHCR_USERNAME }}"
            GHCR_PAT="${{ secrets.GHCR_TOKEN }}"
            if [ -z "$GHCR_USER" ]; then GHCR_USER="${{ github.actor }}"; fi
            if [ -z "$GHCR_PAT" ]; then GHCR_PAT="${{ secrets.GITHUB_TOKEN }}"; fi

            if [ -z "$GHCR_USER" ] || [ -z "$GHCR_PAT" ]; then
              echo "::error::No GHCR credentials available. Set GHCR_USERNAME/GHCR_TOKEN secrets, or allow GITHUB_TOKEN package read access."
              exit 1
            fi

            echo "$GHCR_PAT" | docker_cmd login ghcr.io -u "$GHCR_USER" --password-stdin

            AVAILABLE_SERVICES="$(compose config --services)"
            echo "Detected compose services:"
            echo "$AVAILABLE_SERVICES"

            SERVICES=""
            for svc in haraka-inbound haraka-submission haraka-outbound haraka-worker caddy cert-copier fail2ban; do
              if echo "$AVAILABLE_SERVICES" | grep -qx "$svc"; then
                SERVICES="$SERVICES $svc"
              fi
            done

            # Backward compatibility for older single-service compose files.
            for legacy in haraka; do
              if echo "$AVAILABLE_SERVICES" | grep -qx "$legacy"; then
                SERVICES="$SERVICES $legacy"
              fi
            done

            SERVICES="$(echo "$SERVICES" | xargs)"
            if [ -z "$SERVICES" ]; then
              echo "::error::No known Haraka services found in compose file."
              exit 1
            fi

            TARGET_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
            TARGET_TAG="${{ github.sha }}"
            COMPOSE_FILES="$COMPOSE_BASE_FILE"
            OVERRIDE_FILE=""
            HARAKA_SERVICE_FOUND=0

            for svc in $SERVICES; do
              case "$svc" in
                haraka|haraka-*)
                  HARAKA_SERVICE_FOUND=1
                  ;;
              esac
            done

            if [ "$HARAKA_SERVICE_FOUND" -eq 1 ]; then
              OVERRIDE_FILE="$(mktemp)"
              {
                echo "services:"
                for svc in $SERVICES; do
                  case "$svc" in
                    haraka|haraka-*)
                      echo "  $svc:"
                      echo "    image: ${TARGET_IMAGE}:${TARGET_TAG}"
                      ;;
                  esac
                done
              } > "$OVERRIDE_FILE"
              COMPOSE_FILES="${COMPOSE_BASE_FILE}:${OVERRIDE_FILE}"
              echo "Injected Haraka image override:"
              cat "$OVERRIDE_FILE"
            fi

            echo "Resolved compose images:"
            IMAGES_FILE="$(mktemp)"
            if COMPOSE_FILE="$COMPOSE_FILES" compose config --images >"$IMAGES_FILE" 2>/dev/null; then
              sed 's/^/  - /' "$IMAGES_FILE"
              rm -f "$IMAGES_FILE"
            else
              rm -f "$IMAGES_FILE"
              echo "  (docker compose version does not support 'config --images')"
            fi

            echo "Deploying services: $SERVICES"
            COMPOSE_FILE="$COMPOSE_FILES" HARAKA_IMAGE_TAG="$TARGET_TAG" compose pull $SERVICES
            COMPOSE_FILE="$COMPOSE_FILES" HARAKA_IMAGE_TAG="$TARGET_TAG" compose up -d $SERVICES
            if [ -n "$OVERRIDE_FILE" ]; then rm -f "$OVERRIDE_FILE"; fi
